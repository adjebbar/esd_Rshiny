# 01-kmeans-app

library(shiny)
library(esd)
source("helpers.R")
load("data/trajectories.atlantic.rda") 

ui <- fluidPage(
  headerPanel('Cyclone trajectories'),
  sidebarPanel(
    selectInput('param', 'Color', c("nao","month","year","slp"), selected="month"),
    checkboxGroupInput("show","Show", list("trajectories","start","end"), 
                       selected="trajectories", inline=TRUE),
    checkboxGroupInput('it', 'Months', list("jan"=1,"feb"=2,"mar"=3,"apr"=4,"may"=5,
                                            "jun"=6,"jul"=7,"aug"=8,"sep"=9,"oct"=10,
                                            "nov"=11,"dec"=12), selected=c(9,10,11,12,1,2), inline=TRUE),
    numericInput('pmax', 'Minimum depth (hPa)', value=990, min=900, max=1000, step=1),
    numericInput('nmin', 'Minimum cyclone lifetime (hours)', value=72, min=24, max=120, step=1),
    numericInput('dmin', 'Minimum trajectory length (km)', value=1000, min=500, max=2000, step=10),
    dateRangeInput('dates', 'Date range', start='2000-01-01', end='2015-12-31', 
                   min='1979-01-01', max='2015-12-31', format='yyyy-mm-dd'),
    sliderInput('xlim', 'Longitude', min=-90, max=90, value=c(-90,90), step=5),
    sliderInput('ylim', 'Latitude', min=20, max=90, value=c(20,90), step=5),
    selectInput('pal', 'Palette', c("BuDOr","rainbow","precip"), selected="BuDOr"),
    numericInput('alpha', 'Transparency', value=0.1, min=0, max=1, step=0.05, width='50%')
  ),
  mainPanel(
    plotOutput('plot1')
  )
)

server <- function(input, output) {
  
  i.yr <- reactive({ select.dates(X,dates=input$dates) })
  i.sn <- reactive({ select.season(X,it=input$it) })
  i.slp <- reactive({ select.param(X,param="pcent",pmin=0,pmax=input$pmax) })
  i.n <- reactive({ select.param(X,param="n",pmin=input$nmin/6,pmax=1E6) })
  i.d <- reactive({ select.param(X,param="d",pmin=input$dmin,pmax=1E6) })
  i.lon <- reactive({ select.param(X,param="lon",pmin=input$xlim[1],pmax=input$xlim[2]) })
  i.lat <- reactive({ select.param(X,param="lat",pmin=input$ylim[1],pmax=input$ylim[2]) })
  
  selectedParam <- reactive({
    switch(input$param,"slp"="pcent","month"="month","year"="year")
  })

  output$plot1 <- renderPlot({
    par(mar = c(5.1, 4.1, 0, 1), mgp=c(2,0.5,0))
    i.all <- i.yr() &  i.sn() & i.slp() & i.n() & i.d() & i.lon() & i.lat()
    selectedCyclones <- subset(X,it=i.all)
    map(selectedCyclones,new=FALSE,type="colors",lwd=5,cex=1.5,
        param=selectedParam(),alpha=input$alpha,
        xlim=c(-90,90),ylim=c(20,90),
        show.start=("start" %in% input$show),
        show.end=("end" %in% input$show),
        show.segment=("trajectories" %in% input$show),verbose=FALSE)
    lines(c(input$xlim[]),
          c(input$ylim[]),lty=2,col="black",lwd=3)
   })

}

shinyApp(ui = ui, server = server)
